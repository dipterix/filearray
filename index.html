<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>File-Backed Array for Out-of-Memory Computation • filearray</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="File-Backed Array for Out-of-Memory Computation">
<meta name="description" content="Stores large arrays in files to avoid occupying large memories. Implemented with super fast gigabyte-level multi-threaded reading/writing via OpenMP. Supports multiple non-character data types (double, float, complex, integer, logical, and raw).">
<meta property="og:description" content="Stores large arrays in files to avoid occupying large memories. Implemented with super fast gigabyte-level multi-threaded reading/writing via OpenMP. Supports multiple non-character data types (double, float, complex, integer, logical, and raw).">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">filearray</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/performance.html">Performance Comparisons - (Numerical)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dipterix/filearray/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><p><img src="https://raw.githubusercontent.com/dipterix/filearray/main/inst/hexbadge.png" height="160px" align="right"></p>
<div class="section level1">
<div class="page-header"><h1 id="file-backed-array-for-out-of-memory-computation">File-Backed Array for Out-of-memory Computation<a class="anchor" aria-label="anchor" href="#file-backed-array-for-out-of-memory-computation"></a>
</h1></div>
<!-- badges: start -->

<p>Stores large arrays in files to avoid occupying large memories. Implemented with super fast gigabyte-level multi-threaded reading/writing via <code>OpenMP</code>. Supports multiple non-character data types (double, float, integer, complex, logical and raw).</p>
<p><img src="https://raw.githubusercontent.com/dipterix/filearray/main/adhoc/readme-speed.png"></p>
<p><small> Speed comparisons with <code>lazyarray</code> (<code>zstd</code>-compressed out-of-memory array), and in-memory operation. The speed test was conducted on an <code>MacBook Air (M1, 2020, 8GB RAM)</code>, with 8-threads. <code>filearray</code> is uniformly faster than <code>lazyarray</code>. Random access has almost the same speed as the native array operation in R. <em>(The actual speed may vary depending on the storage type and memory size)</em> </small></p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"filearray"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="install-develop-version">Install Develop Version<a class="anchor" aria-label="anchor" href="#install-develop-version"></a>
</h3>
<p>The internal functions are written in <code>C++</code>. To avoid compiling the packages, you can install from my personal repository. It’s automatically updated every hour. Currently available on <code>Windows</code> and <code>osx (Intel chip)</code> only.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    dipterix <span class="op">=</span> <span class="st">'https://dipterix.r-universe.dev'</span>,</span>
<span>    CRAN <span class="op">=</span> <span class="st">'https://cloud.r-project.org'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'filearray'</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, you can compile from <code>Github</code> repository. This requires proper compilers (<code>rtools</code> on <code>windows</code>, or <code>xcode-select --install</code> on <code>osx</code>, or <code>build-essentials</code> on <code>linux</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"dipterix/filearray"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic Usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<div class="section level4">
<h4 id="createload-file-array">Create/load file array<a class="anchor" aria-label="anchor" href="#createload-file-array"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dipterix.org/filearray/">filearray</a></span><span class="op">)</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/filearray.html">filearray_create</a></span><span class="op">(</span><span class="va">file</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load existing</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/filearray.html">filearray_load</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span></code></pre></div>
<p>See more: <code><a href="reference/filearray.html">help("filearray")</a></code></p>
</div>
<div class="section level4">
<h4 id="assign--subset-array">Assign &amp; subset array<a class="anchor" aria-label="anchor" href="#assign--subset-array"></a>
</h4>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="generics">Generics<a class="anchor" aria-label="anchor" href="#generics"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/typeof.html">typeof</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">3</span>, <span class="va">min</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">val</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">5</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="reference/fwhich.html">fwhich</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">val</span>, arr.ind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>See more: <code><a href="reference/S3-filearray.html">help("S3-filearray")</a></code>, <code><a href="reference/fwhich.html">help("fwhich")</a></code></p>
</div>
<div class="section level4">
<h4 id="map-reduce">Map-reduce<a class="anchor" aria-label="anchor" href="#map-reduce"></a>
</h4>
<p>Process segments of array and reduce to save memories.</p>
<pre><code><span><span class="co"># Identical to sum(x, na.rm = TRUE)</span></span>
<span><span class="fu"><a href="reference/mapreduce.html">mapreduce</a></span><span class="op">(</span><span class="va">x</span>,</span>
<span>          map <span class="op">=</span> \<span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">}</span>,</span>
<span>          reduce <span class="op">=</span> \<span class="op">(</span><span class="va">mapped</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">sum</span>, <span class="va">mapped</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span></code></pre>
<p>See more: <code><a href="reference/mapreduce.html">help("mapreduce")</a></code></p>
</div>
<div class="section level4">
<h4 id="collapse">Collapse<a class="anchor" aria-label="anchor" href="#collapse"></a>
</h4>
<p>Transform data, and collapse (calculate sum or mean) along margins.</p>
<pre><code><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="fu">collapse</span><span class="op">(</span>keep <span class="op">=</span> <span class="fl">4</span>, method <span class="op">=</span> <span class="st">"mean"</span>, transform <span class="op">=</span> <span class="st">"asis"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># equivalent to</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">]</span>, <span class="fl">4</span>, <span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">b</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre>
<p>Available <code>transform</code> for double/integer numbers are:</p>
<ul>
<li>
<code>asis</code>: no transform</li>
<li>
<code>10log10</code>: <code>10 * log10(v)</code>
</li>
<li>
<code>square</code>: <code>v * v</code>
</li>
<li>
<code>sqrt</code>: <code>sqrt(v)</code>
</li>
</ul>
<p>For complex numbers, <code>transform</code> is a little bit different:</p>
<ul>
<li>
<code>asis</code>: no transform</li>
<li>
<code>10log10</code>: <code>10 * log10(|x|^2)</code> (power to decibel unit)</li>
<li>
<code>square</code>: <code>|x|^2</code>
</li>
<li>
<code>sqrt</code>: <code>|x|</code> (modulus)</li>
<li>
<code>normalize</code>: <code>x / |x|</code> (unit length)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h2>
<div class="section level4">
<h4 id="i-notes-on-precision">I. Notes on precision<a class="anchor" aria-label="anchor" href="#i-notes-on-precision"></a>
</h4>
<ol style="list-style-type: decimal">
<li><p><code>complex</code> numbers: In native <code>R</code>, complex numbers are combination of two <code>double</code> numbers - real and imaginary (total 16 bytes). In <code>filearray</code>, complex numbers are coerced to two <code>float</code> numbers and store each number in 8 bytes. This conversion will gain performance speed, but lose precision at around 8 decimal place. For example, <code>1.0000001</code> will be store as <code>1</code>, or <code>123456789</code> will be stored as <code>123456792</code> (first 7 digits are accurate).</p></li>
<li><p><code>float</code> type: Native R does not have float type. All numeric values are stored in double precision. Since float numbers use half of the space, float arrays can be faster when hard drive speed is the bottle-neck (see <a href="https://dipterix.org/filearray/articles/performance.html">performance comparisons</a>). However coercing double to float comes at costs: a). float number has less precision b). float number has smaller range (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3.4</mn><mo>×</mo><msup><mn>10</mn><mn>38</mn></msup></mrow><annotation encoding="application/x-tex">3.4\times 10^{38}</annotation></semantics></math>) than double (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.7</mn><mo>×</mo><msup><mn>10</mn><mn>308</mn></msup></mrow><annotation encoding="application/x-tex">1.7\times 10^{308}</annotation></semantics></math>) hence use with caution when data needs high precision or the max is super large.</p></li>
<li><p><code>collapse</code> function: when data range is large (say <code>x[[1]]=1</code>, but <code>x[[2]]=10^20</code>), <code>collapse</code> method might lose precision. This is <code>double</code> only uses 8 bytes of memory space. When calculating summations, R internally uses <code>long double</code> to prevent precision loss, but current <code>filearray</code> implementation uses <code>double</code>, causing floating error around 16 decimal place.</p></li>
</ol>
</div>
<div class="section level4">
<h4 id="ii-cold-start-vs-warm-start">II. Cold-start vs warm-start<a class="anchor" aria-label="anchor" href="#ii-cold-start-vs-warm-start"></a>
</h4>
<p>As of version <code>0.1.1</code>, most file read/write operations are switched from <code>fopen</code> to memory map for two simplify the logic (buffer size, kernel cache…), and to boost the writing/some types of reading speed. While sacrificing the speed of reading large block of data from 2.4GB/s to 1.7GB/s, the writing speed was boosted from 300MB/s to 700MB/s, and the speed of random accessing small slices of data was increased from 900MB/s to 2.5GB/s. As a result, some functions can reach to really high speed (close to in-memory calls) while using much less memory.</p>
<p>The additional performance improvements brought by the memory mapping approach might be impacted by “cold” start. When reading/writing files, most modern systems will cache the files so that it can load up these files faster next time. I personally call it a cold start. Memory mapping have a little bit extra overhead during the cold start, resulting in decreased performance (but it’s still fast). Accessing the same data after the cold start is called warm start. When operating with warm starts, <code>filearray</code> is as fast as native R arrays (sometimes even faster due to the indexing method and fewer garbage collections). This means <code>filearray</code> reaches its best performance when the arrays are re-used.</p>
</div>
<div class="section level4">
<h4 id="iii-using-traditional-hdd">III. Using traditional HDD?<a class="anchor" aria-label="anchor" href="#iii-using-traditional-hdd"></a>
</h4>
<p><code>filearray</code> relies on <code>SSD</code>, especially <code>NVMe SSD</code> that allows you to fast-access random hard disk address. If you use <code>HDD</code>, <code>filearray</code> can provide very limited improvement.</p>
<p>If you use <code>filearray</code> to direct access to HDD, please set number of threads to <code>1</code> via <code>filearray::filearray_threads(1)</code> at start up, or set system environment <code>FILEARRAY_NUM_THREADS</code> to <code>"1"</code>.</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=filearray" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/dipterix/filearray/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/dipterix/filearray/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/LGPL-3" class="external-link">LGPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing filearray</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Zhengjia Wang <br><small class="roles"> Author, maintainer, copyright holder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/dipterix/filearray/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/dipterix/filearray/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-check"></a></li>
<li><a href="https://CRAN.R-project.org/package=filearray" class="external-link"><img src="https://www.r-pkg.org/badges/version/filearray" alt="CRAN status"></a></li>
<li><a href="https://dipterix.r-universe.dev/" class="external-link"><img src="https://dipterix.r-universe.dev/badges/filearray" alt="Develop"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zhengjia Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
